@using FGI.Enums
@model List<Lead>
@{
    ViewData["Title"] = "Leads Management";
    var inProgressLeads = Model.Where(l => l.CurrentStatus != LeadStatusType.Canceled &&
                                        l.CurrentStatus != LeadStatusType.DoneDeal).ToList();
    var canceledLeads = Model.Where(l => l.CurrentStatus == LeadStatusType.Canceled).ToList();
    var doneDealLeads = Model.Where(l => l.CurrentStatus == LeadStatusType.DoneDeal).ToList();
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h4 text-gray-800 mb-0">
                <i class="fas fa-user-tie text-primary mr-2"></i>Leads Management
            </h1>
            <p class="text-muted small mt-1">Manage all your leads in one place</p>
        </div>
        <a asp-action="Create" class="btn btn-primary">
            <i class="fas fa-plus-circle mr-2"></i>Add New Lead
        </a>
    </div>

    <!-- Filter Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <h6 class="m-0 font-weight-normal text-gray-700">
                <i class="fas fa-filter text-primary mr-1"></i> Filter Leads
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="font-weight-bold">Status</label>
                        <select class="form-control" id="statusFilter">
                            <option value="all">All Statuses</option>
                            @foreach (var status in Enum.GetValues(typeof(LeadStatusType)))
                            {
                                <option value="@status">@status</option>
                            }
                        </select>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="font-weight-bold">Assigned To</label>
                        <select class="form-control" id="assignedFilter">
                            <option value="all">All Users</option>
                            @if (ViewBag.Sales != null)
                            {
                                foreach (var user in (List<SelectListItem>)ViewBag.Sales)
                                {
                                    <option value="@user.Value">@user.Text</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="font-weight-bold">Search</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search leads...">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" id="searchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mt-3">
                    <button class="btn btn-outline-secondary" id="resetFilters">
                        <i class="fas fa-sync-alt mr-2"></i>Reset Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="leadsTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="inprogress-tab" data-toggle="tab" href="#inprogress" role="tab">
                <i class="fas fa-tasks mr-1"></i> In Progress
                <span class="badge badge-primary ml-2">@inProgressLeads.Count</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="donedeal-tab" data-toggle="tab" href="#donedeal" role="tab">
                <i class="fas fa-check-circle mr-1"></i> Done Deals
                <span class="badge badge-success ml-2">@doneDealLeads.Count</span>
            </a>
        </li>
        @if (canceledLeads.Any())
        {
            <li class="nav-item">
                <a class="nav-link" id="canceled-tab" data-toggle="tab" href="#canceled" role="tab">
                    <i class="fas fa-times-circle mr-1"></i> Canceled
                    <span class="badge badge-danger ml-2">@canceledLeads.Count</span>
                </a>
            </li>
        }
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="leadsTabContent">
        <!-- In Progress Leads Tab -->
        <div class="tab-pane fade show active" id="inprogress" role="tabpanel">
            <div class="card border-0 shadow-sm rounded-lg">
                <div class="card-body p-0">
                    @if (inProgressLeads.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" width="100%" cellspacing="0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="pl-4">Client</th>
                                        <th>Contact</th>
                                        <th>Project</th>
                                        <th>Unit</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Assigned To</th>
                                        <th>Last Updated</th>
                                        <th class="text-right pr-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var lead in inProgressLeads.OrderByDescending(l => l.CreatedAt))
                                    {
                                        <tr>
                                            <td class="pl-4 font-weight-medium">@lead.ClientName</td>
                                            <td>
                                                <a href="tel:@lead.ClientPhone" class="text-muted">
                                                    <i class="fas fa-phone-alt mr-1 text-primary"></i>@lead.ClientPhone
                                                </a>
                                            </td>
                                            <td>@lead.Project?.Name</td>
                                            <td>
                                                @if (lead.Unit != null)
                                                {
                                                    <span>@lead.Unit.UnitCode (@lead.Unit.Type)</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                @if (lead.Unit != null)
                                                {
                                                    <span>@(lead.Unit.Currency == Currency.USD ? "$" : "EGP") @lead.Unit.Price.ToString("N0")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge @GetStatusBadgeClass(lead.CurrentStatus)">
                                                    @lead.CurrentStatus
                                                </span>
                                            </td>
                                            <td>
                                                @if (lead.AssignedTo != null)
                                                {
                                                    <span class="d-flex align-items-center">
                                                        @lead.AssignedTo.FullName
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Unassigned</span>
                                                }
                                            </td>
                                            <td>
                                                @(lead.UpdatedAt?.ToString("dd MMM yyyy") ?? lead.CreatedAt.ToString("dd MMM yyyy"))
                                            </td>
                                            <td class="text-right pr-4">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a asp-action="Details" asp-route-id="@lead.Id"
                                                       class="btn btn-outline-primary" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a asp-action="Edit" asp-route-id="@lead.Id"
                                                       class="btn btn-outline-secondary" title="Edit">
                                                        <i class="fas fa-pencil-alt"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-3"></i>
                            <h5>No leads in progress</h5>
                            <p>All your active leads will appear here</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Done Deals Tab -->
        <div class="tab-pane fade" id="donedeal" role="tabpanel">
            <div class="card border-0 shadow-sm rounded-lg">
                <div class="card-body p-0">
                    @if (doneDealLeads.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" width="100%" cellspacing="0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="pl-4">Client</th>
                                        <th>Contact</th>
                                        <th>Project</th>
                                        <th>Unit</th>
                                        <th>Price</th>
                                        <th>Assigned To</th>
                                        <th>Completed On</th>
                                        <th class="text-right pr-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var lead in doneDealLeads.OrderByDescending(l => l.CreatedAt))
                                    {
                                        <tr>
                                            <td class="pl-4 font-weight-medium">@lead.ClientName</td>
                                            <td>
                                                <a href="tel:@lead.ClientPhone" class="text-muted">
                                                    <i class="fas fa-phone-alt mr-1 text-primary"></i>@lead.ClientPhone
                                                </a>
                                            </td>
                                            <td>@lead.Project?.Name</td>
                                            <td>
                                                @if (lead.Unit != null)
                                                {
                                                    <span>@lead.Unit.UnitCode (@lead.Unit.Type)</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                @if (lead.Unit != null)
                                                {
                                                    <span>@(lead.Unit.Currency == Currency.USD ? "$" : "EGP") @lead.Unit.Price.ToString("N0")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                @if (lead.AssignedTo != null)
                                                {
                                                    <span class="d-flex align-items-center">
                                                        @lead.AssignedTo.FullName
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Unassigned</span>
                                                }
                                            </td>
                                            <td>
                                                @(lead.UpdatedAt?.ToString("dd MMM yyyy") ?? lead.CreatedAt.ToString("dd MMM yyyy"))
                                            </td>
                                            <td class="text-right pr-4">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a asp-action="Details" asp-route-id="@lead.Id"
                                                       class="btn btn-outline-primary" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-check-circle fa-2x mb-3"></i>
                            <h5>No completed deals</h5>
                            <p>Your successful deals will appear here</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Canceled Leads Tab (only shown if there are canceled leads) -->
        @if (canceledLeads.Any())
        {
            <div class="tab-pane fade" id="canceled" role="tabpanel">
                <div class="card border-0 shadow-sm rounded-lg">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" width="100%" cellspacing="0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="pl-4">Client</th>
                                        <th>Contact</th>
                                        <th>Project</th>
                                        <th>Unit</th>
                                        <th>Price</th>
                                        <th>Assigned To</th>
                                        <th>Canceled On</th>
                                        <th class="text-right pr-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var lead in canceledLeads.OrderByDescending(l => l.CreatedAt))
                                    {
                                        <tr>
                                            <td class="pl-4 font-weight-medium">@lead.ClientName</td>
                                            <td>
                                                <a href="tel:@lead.ClientPhone" class="text-muted">
                                                    <i class="fas fa-phone-alt mr-1 text-primary"></i>@lead.ClientPhone
                                                </a>
                                            </td>
                                            <td>@lead.Project?.Name</td>
                                            <td>
                                                @if (lead.Unit != null)
                                                {
                                                    <span>@lead.Unit.UnitCode (@lead.Unit.Type)</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                @if (lead.Unit != null)
                                                {
                                                    <span>@(lead.Unit.Currency == Currency.USD ? "$" : "EGP") @lead.Unit.Price.ToString("N0")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                @if (lead.AssignedTo != null)
                                                {
                                                    <span class="d-flex align-items-center">
                                                        @lead.AssignedTo.FullName
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Unassigned</span>
                                                }
                                            </td>
                                            <td>
                                                @lead.UpdatedAt?.ToString("dd MMM yyyy")
                                            </td>
                                            <td class="text-right pr-4">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a asp-action="Details" asp-route-id="@lead.Id"
                                                       class="btn btn-outline-primary" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@functions {
    string GetStatusBadgeClass(LeadStatusType status)
    {
        return status switch
        {
            LeadStatusType.New => "badge-primary",
            LeadStatusType.WrongNumber => "badge-info",
            LeadStatusType.NoAnswer => "badge-warning",
            LeadStatusType.FollowUp => "badge-secondary",
            LeadStatusType.DoneDeal => "badge-success",
            LeadStatusType.Canceled => "badge-danger",
            _ => "badge-secondary"
        };
    }
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize tab functionality
            $('#leadsTab a').on('click', function (e) {
                e.preventDefault();
                $(this).tab('show');
                // إعادة تطبيق الفلتر عند تغيير التبويب
                applyFilters();
            });

            // تطبيق الفلتر عند الضغط على زر البحث أو تغيير أي فلتر
            $('#searchButton').on('click', applyFilters);
            $('#statusFilter, #assignedFilter').on('change', applyFilters);
            $('#searchInput').on('keyup', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });

            // زر reset للفلتر
            $('#resetFilters').on('click', function() {
                $('#statusFilter').val('all');
                $('#assignedFilter').val('all');
                $('#searchInput').val('');
                applyFilters();
            });

            function applyFilters() {
                var searchTerm = $('#searchInput').val().toLowerCase();
                var statusFilter = $('#statusFilter').val();
                var assignedFilter = $('#assignedFilter').val();

                // الحصول على التبويب النشط فقط
                var activeTab = $('#leadsTabContent .tab-pane.active');
                var table = activeTab.find('table');

                if (table.length === 0) return;

                table.find('tbody tr').each(function() {
                    var $row = $(this);
                    var rowText = $row.text().toLowerCase();

                    // الحصول على بيانات محددة من الصف
                    var rowStatus = $row.find('td:eq(5)').text().trim().toLowerCase();
                    var rowAssigned = $row.find('td:eq(6)').text().trim().toLowerCase();
                    var rowClient = $row.find('td:eq(0)').text().trim().toLowerCase();
                    var rowPhone = $row.find('td:eq(1)').text().trim().toLowerCase();
                    var rowProject = $row.find('td:eq(2)').text().trim().toLowerCase();

                    var matchesSearch = searchTerm === '' ||
                                     rowText.indexOf(searchTerm) > -1 ||
                                     rowClient.indexOf(searchTerm) > -1 ||
                                     rowPhone.indexOf(searchTerm) > -1 ||
                                     rowProject.indexOf(searchTerm) > -1;

                    var matchesStatus = statusFilter === 'all' ||
                                     rowStatus === statusFilter.toLowerCase();

                    var matchesAssigned = assignedFilter === 'all' ||
                                      rowAssigned.indexOf(assignedFilter.toLowerCase()) > -1;

                    if (matchesSearch && matchesStatus && matchesAssigned) {
                        $row.show();
                    } else {
                        $row.hide();
                    }
                });

                // إظهار رسالة إذا لم توجد نتائج
                var visibleRows = table.find('tbody tr:visible').length;
                if (visibleRows === 0) {
                    if (!table.next('.no-results-message').length) {
                        table.after('<div class="no-results-message p-4 text-center text-muted"><i class="fas fa-search fa-2x mb-3"></i><h5>No matching leads found</h5><p>Try adjusting your filters</p></div>');
                    }
                } else {
                    table.next('.no-results-message').remove();
                }
            }

            // تفعيل الفلتر لأول مرة عند التحميل
            applyFilters();
        });
    </script>
}

@section Styles {
    <style>
        /* Improved badge styling */
        .badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.35em 0.65em;
            border-radius: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Color adjustments for better visibility */
        .badge-primary {
            background-color: #4e73df;
            color: white;
        }

        .badge-info {
            background-color: #36b9cc;
            color: white;
        }

        .badge-warning {
            background-color: #f6c23e;
            color: #2e2e2e;
        }

        .badge-secondary {
            background-color: #858796;
            color: white;
        }

        .badge-success {
            background-color: #1cc88a;
            color: white;
        }

        .badge-danger {
            background-color: #e74a3b;
            color: white;
        }

        /* Table row hover effect */
        .table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

            /* Ensure badges stand out on hover */
            .table tbody tr:hover .badge {
                opacity: 0.9;
                box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            }

        /* Tab styling */
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }

            .nav-tabs .nav-link {
                border: none;
                color: #6c757d;
                font-weight: 500;
                padding: 0.75rem 1.25rem;
                border-radius: 0;
            }

                .nav-tabs .nav-link.active {
                    color: #4e73df;
                    background-color: transparent;
                    border-bottom: 2px solid #4e73df;
                    margin-bottom: -2px;
                }

                .nav-tabs .nav-link:hover {
                    border-color: transparent;
                    color: #4e73df;
                }

        /* Card styling */
        .card {
            border: none;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        }

        /* Empty state styling */
        .text-muted i {
            opacity: 0.5;
        }

        /* No results message styling */
        .no-results-message {
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
        }

        /* تحسين مظهر حقول الفلتر */
        #statusFilter, #assignedFilter, #searchInput {
            border: 1px solid #ddd;
            transition: all 0.3s ease;
        }

            #statusFilter:focus, #assignedFilter:focus, #searchInput:focus {
                border-color: #4e73df;
                box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
            }
    </style>
}