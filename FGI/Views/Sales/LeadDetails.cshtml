@using FGI.Enums
@model Lead
@{
    ViewData["Title"] = "Lead Details";
}

<div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-dark">Lead Details</h1>
        <a asp-action="MyLeads" class="btn btn-secondary shadow-sm">
            <i class="fas fa-arrow-left me-1"></i> Back to My Leads
        </a>
    </div>

    <!-- Status Messages -->
    @if (Model.CurrentStatus == LeadStatusType.DoneDeal)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <strong>Congratulations!</strong> The deal has been successfully completed.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    else if (Model.CurrentStatus == LeadStatusType.Canceled)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <strong>Sorry!</strong> The deal was not completed.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row g-4">
        <div class="col-lg-8">
            <!-- Client Information Card -->
            <div class="card shadow-sm mb-4 fade-in">
                <div class="card-header bg-primary text-white py-3">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-user me-1"></i> Client Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <h6 class="text-primary">Basic Information</h6>
                            <hr class="mt-1">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Client Name</dt>
                                <dd class="col-sm-8">@Model.ClientName</dd>
                                <dt class="col-sm-4">Phone Number</dt>
                                <dd class="col-sm-8">@Model.ClientPhone</dd>
                                <dt class="col-sm-4">Created On</dt>
                                <dd class="col-sm-8">@Model.CreatedAt.ToString("MMM dd, yyyy")</dd>
                            </dl>
                        </div>
                        <div class="col-md-6 mb-4">
                            <h6 class="text-primary">Project Details</h6>
                            <hr class="mt-1">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Project</dt>
                                <dd class="col-sm-8">@Model.Project?.Name</dd>
                                <dt class="col-sm-4">Unit Code</dt>
                                <dd class="col-sm-8">@Model.Unit?.UnitCode</dd>
                                <dt class="col-sm-4">Current Status</dt>
                                <dd class="col-sm-8">
                                    <span class="badge @GetStatusBadgeClass(Model.CurrentStatus)">
                                        @Model.CurrentStatus
                                    </span>
                                </dd>
                            </dl>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.Comment))
                    {
                        <div class="mt-3">
                            <h6 class="text-primary">Client Comment</h6>
                            <hr class="mt-1">
                            <p class="text-muted">@Model.Comment</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Unit Details Card -->
            <div class="card shadow-sm mb-4 fade-in">
                <div class="card-header bg-info text-white py-3">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-home me-1"></i> Unit Details</h6>
                </div>
                <div class="card-body">
                    @if (Model.Unit != null)
                    {
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <dl class="row mb-0">
                                    <dt class="col-sm-5">Unit Code</dt>
                                    <dd class="col-sm-7">@(Model.Unit.UnitCode ?? "N/A")</dd>
                                    <dt class="col-sm-5">Unit Type</dt>
                                    <dd class="col-sm-7">@Model.Unit.Type</dd>
                                    <dt class="col-sm-5">Sale Type</dt>
                                    <dd class="col-sm-7">@Model.Unit.UnitType</dd>
                                    <dt class="col-sm-5">Location</dt>
                                    <dd class="col-sm-7">@Model.Unit.Location</dd>
                                    <dt class="col-sm-5">Price</dt>
                                    <dd class="col-sm-7">@Model.Unit.Price.ToString("C")</dd>
                                </dl>
                            </div>
                            <div class="col-md-6 mb-4">
                                <dl class="row mb-0">
                                    <dt class="col-sm-5">Area</dt>
                                    <dd class="col-sm-7">@Model.Unit.Area sqm</dd>
                                    <dt class="col-sm-5">Bedrooms</dt>
                                    <dd class="col-sm-7">@Model.Unit.Bedrooms</dd>
                                    <dt class="col-sm-5">Bathrooms</dt>
                                    <dd class="col-sm-7">@Model.Unit.Bathrooms</dd>
                                    <dt class="col-sm-5">Price per Sqm</dt>
                                    <dd class="col-sm-7">@((Model.Unit.Area > 0 ? Model.Unit.Price / Model.Unit.Area : 0).ToString("C"))</dd>
                                </dl>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.Unit.Description))
                        {
                            <div class="mt-3">
                                <h6 class="text-primary">Additional Notes</h6>
                                <hr class="mt-1">
                                <p class="text-muted">@Model.Unit.Description</p>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-4 empty-state">
                            <i class="fas fa-home fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No unit assigned to this lead</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Activity History Card -->
            <div class="card shadow-sm mb-4 fade-in">
                <div class="card-header bg-success text-white py-3">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-history me-1"></i> Activity History</h6>
                </div>
                <div class="card-body">
                    @if (ViewBag.Feedbacks != null && ((IEnumerable<LeadFeedback>)ViewBag.Feedbacks).Any())
                    {
                        <div class="timeline">
                            @foreach (var feedback in ((IEnumerable<LeadFeedback>)ViewBag.Feedbacks).OrderByDescending(f => f.CreatedAt))
                            {
                                <div class="timeline-item">
                                    <div class="timeline-icon bg-@GetStatusColor(feedback.Status)">
                                        <i class="fas @GetStatusIcon(feedback.Status) text-white"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">@feedback.Sales?.FullName</h6>
                                            <small class="text-muted">@feedback.CreatedAt.ToString("MMM dd, yyyy hh:mm tt")</small>
                                        </div>
                                        <p class="mb-1"><strong>Status:</strong> @feedback.Status</p>
                                        <p class="text-muted">@feedback.Comment</p>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4 empty-state">
                            <i class="fas fa-comment-slash fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No activity history found</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Actions Panel -->
        <div class="col-lg-4">
            @if (Model.CurrentStatus != LeadStatusType.DoneDeal && Model.CurrentStatus != LeadStatusType.Canceled)
            {
                <div class="card shadow-sm mb-4 fade-in">
                    <div class="card-header bg-info text-white py-3">
                        <h6 class="m-0 font-weight-bold"><i class="fas fa-cog me-1"></i> Lead Actions</h6>
                    </div>
                    <div class="card-body">
                        @if (Model.Unit == null)
                        {
                            <div class="mb-3">
                                <a asp-action="AssignUnitToLead" asp-route-leadId="@Model.Id"
                                   class="btn btn-primary btn-block">
                                    <i class="fas fa-home me-1"></i> Assign Unit
                                </a>
                            </div>
                        }
                        <form asp-action="UpdateStatus" method="post">
                            <input type="hidden" name="leadId" value="@Model.Id" />
                            <div class="form-group mb-3">
                                <label for="status" class="form-label">Update Status</label>
                                <select name="status" class="form-select" required>
                                    @foreach (LeadStatusType status in Enum.GetValues(typeof(LeadStatusType)))
                                    {
                                        if (status != LeadStatusType.New && status != Model.CurrentStatus)
                                        {
                                            <option value="@status">@status</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="form-group mb-3">
                                <label for="comment" class="form-label">Add Comment</label>
                                <textarea name="comment" class="form-control" rows="4" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="fas fa-save me-1"></i> Update Lead
                            </button>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-sm mb-4 fade-in">
                    <div class="card-header bg-secondary text-white py-3">
                        <h6 class="m-0 font-weight-bold"><i class="fas fa-info-circle me-1"></i> Lead Status</h6>
                    </div>
                    <div class="card-body text-center">
                        @if (Model.CurrentStatus == LeadStatusType.DoneDeal)
                        {
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h5 class="text-success">Deal Completed</h5>
                            <p class="text-muted">No further actions available</p>
                        }
                        else
                        {
                            <i class="fas fa-times-circle fa-3x text-danger mb-3"></i>
                            <h5 class="text-danger">Deal Canceled</h5>
                            <p class="text-muted">No further actions available</p>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@functions {
    string GetStatusBadgeClass(LeadStatusType status)
    {
        return status switch
        {
            LeadStatusType.New => "bg-primary",
            LeadStatusType.WrongNumber => "bg-info",
            LeadStatusType.NoAnswer => "bg-warning",
            LeadStatusType.FollowUp => "bg-secondary",
            LeadStatusType.DoneDeal => "bg-success",
            LeadStatusType.Canceled => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetStatusColor(LeadStatusType status)
    {
        return status switch
        {
            LeadStatusType.New => "primary",
            LeadStatusType.WrongNumber => "info",
            LeadStatusType.NoAnswer => "warning",
            LeadStatusType.FollowUp => "secondary",
            LeadStatusType.DoneDeal => "success",
            LeadStatusType.Canceled => "danger",
            _ => "secondary"
        };
    }

    string GetStatusIcon(LeadStatusType status)
    {
        return status switch
        {
            LeadStatusType.New => "fa-user-plus",
            LeadStatusType.WrongNumber => "fa-phone",
            LeadStatusType.NoAnswer => "fa-check-circle",
            LeadStatusType.FollowUp => "fa-clock",
            LeadStatusType.DoneDeal => "fa-check-double",
            LeadStatusType.Canceled => "fa-times-circle",
            _ => "fa-info-circle"
        };
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/sales/lead-details.css" asp-append-version="true">
}

@section Scripts {
    <script src="~/js/sales/lead-details.js" asp-append-version="true"></script>
}