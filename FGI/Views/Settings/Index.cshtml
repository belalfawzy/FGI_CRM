@model FGI.ViewModels.UserSettingsViewModel
@{
    ViewData["Title"] = "Settings";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Head {
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4e73df',
                        'primary-dark': '#3a56c4',
                        secondary: '#6f42c1',
                        success: '#1cc88a',
                        info: '#36b9cc',
                        warning: '#f6c23e',
                        danger: '#e74a3b',
                        light: '#f8f9fc',
                        dark: '#5a5c69'
                    }
                }
            }
        }
    </script>
    <style>
        /* Ensure Font Awesome icons display properly with TailwindCSS */
        .fas, .far, .fab, .fal, .fad {
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900 !important;
            display: inline-block !important;
        }
        
        /* Fix navbar components */
        .navbar-nav {
            display: flex !important;
            flex-direction: row !important;
        }
        
        .nav-item {
            display: block !important;
        }
        
        .nav-link {
            display: block !important;
            padding: 0.5rem 1rem !important;
        }
        
        /* Ensure icons in TailwindCSS sections work */
        .tailwind-section i {
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900 !important;
            display: inline-block !important;
        }
    </style>
}

<div class="min-h-screen bg-gray-50 py-8 tailwind-section">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-gradient-to-r from-primary to-primary-dark rounded-2xl shadow-xl p-6 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="p-3">
                        <i class="fas fa-cog text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white">Account Settings</h1>
                        <p class="text-blue-100 mt-1">Manage your account information and security</p>
                    </div>
                </div>
                <a asp-controller="Profile" asp-action="Index" class="text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 flex items-center space-x-2">
                    <i class="fas fa-user"></i>
                    <span>Back to Profile</span>
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Profile Information Card -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-primary px-6 py-4">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <i class="fas fa-user mr-3"></i>
                        Profile Information
                    </h2>
                </div>
                <div class="p-6">
                    <form id="profileForm">
                        <div class="mb-6">
                            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200" id="fullName" value="@Model.FullName" required>
                            <p class="mt-2 text-sm text-gray-500">Your display name in the system</p>
                        </div>
                        <button type="button" class="w-full bg-primary hover:bg-primary-dark text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2" id="updateProfileBtn">
                            <i class="fas fa-save"></i>
                            <span>Update Profile</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Email Settings Card -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-success px-6 py-4">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <i class="fas fa-envelope mr-3"></i>
                        Email Settings
                    </h2>
                </div>
                <div class="p-6">
                    <form id="emailForm">
                        <div class="mb-6">
                            <label for="currentEmail" class="block text-sm font-medium text-gray-700 mb-2">Current Email</label>
                            <input type="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-500" id="currentEmail" value="@Model.Email" readonly>
                            <p class="mt-2 text-sm text-gray-500">Your current email address</p>
                        </div>
                        <div class="mb-6">
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <div class="flex">
                                <input type="text" class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-success focus:border-transparent transition-all duration-200" id="username" value="@Model.Username" required>
                                <span class="px-4 py-3 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-600 font-medium">@Model.Domain</span>
                            </div>
                            <p class="mt-2 text-sm text-gray-500">You can only change the part before @@ The domain (@@role.fgi) is fixed.</p>
                        </div>
                        <button type="button" class="w-full bg-success hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2" id="updateEmailBtn">
                            <i class="fas fa-envelope"></i>
                            <span>Update Email</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
            <!-- Password Settings Card -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-warning px-6 py-4">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <i class="fas fa-lock mr-3"></i>
                        Password Settings
                    </h2>
                </div>
                <div class="p-6">
                    <form id="passwordForm">
                        <div class="mb-6">
                            <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                            <input type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-transparent transition-all duration-200" id="currentPassword" required>
                            <p class="mt-2 text-sm text-gray-500">Enter your current password to confirm changes</p>
                        </div>
                        <div class="mb-6">
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                            <input type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-transparent transition-all duration-200" id="newPassword" required minlength="6">
                            <p class="mt-2 text-sm text-gray-500">Password must be at least 6 characters long</p>
                        </div>
                        <div class="mb-6">
                            <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                            <input type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-warning focus:border-transparent transition-all duration-200" id="confirmPassword" required minlength="6">
                            <p class="mt-2 text-sm text-gray-500">Re-enter your new password</p>
                        </div>
                        <button type="button" class="w-full bg-warning hover:bg-yellow-600 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2" id="updatePasswordBtn">
                            <i class="fas fa-lock"></i>
                            <span>Update Password</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Account Information Card -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-info px-6 py-4">
                    <h2 class="text-xl font-semibold text-white flex items-center">
                        <i class="fas fa-info-circle mr-3"></i>
                        Account Information
                    </h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div class="flex items-center p-4 bg-gray-50 rounded-lg">
                            <i class="fas fa-envelope text-primary mr-4 text-lg"></i>
                            <div>
                                <p class="font-medium text-gray-900">Email Address</p>
                                <p class="text-sm text-gray-600">@Model.Email</p>
                            </div>
                        </div>
                        <div class="flex items-center p-4 bg-gray-50 rounded-lg">
                            <i class="fas fa-user-tag text-primary mr-4 text-lg"></i>
                            <div>
                                <p class="font-medium text-gray-900">User Role</p>
                                <p class="text-sm text-gray-600">@Model.Role</p>
                            </div>
                        </div>
                        <div class="flex items-center p-4 bg-gray-50 rounded-lg">
                            <i class="fas fa-id-badge text-primary mr-4 text-lg"></i>
                            <div>
                                <p class="font-medium text-gray-900">User ID</p>
                                <p class="text-sm text-gray-600">#@Model.UserId</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <div class="text-center">
                            <div class="flex items-center justify-center mb-4">
                                <i class="fas fa-shield-alt text-green-500 text-2xl mr-3"></i>
                                <p class="text-gray-600 font-medium">Your account is secure and protected</p>
                            </div>
                            <a href="@Url.Action("Index", "Profile")" class="inline-flex items-center px-6 py-3 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-all duration-200">
                                <i class="fas fa-user mr-2"></i>
                                View Profile
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="successMessage">
            <!-- Success message will be inserted here -->
        </div>
    </div>
    
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="errorMessage">
            <!-- Error message will be inserted here -->
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Update Profile
            $('#updateProfileBtn').click(function() {
                const fullName = $('#fullName').val().trim();
                
                if (!fullName) {
                    showError('Full name is required');
                    return;
                }

                $.ajax({
                    url: '@Url.Action("UpdateProfile", "Settings")',
                    type: 'POST',
                    data: {
                        fullName: fullName,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            showSuccess(response.message);
                        } else {
                            showError(response.message);
                        }
                    },
                    error: function() {
                        showError('Error updating profile');
                    }
                });
            });

            // Update Email
            $('#updateEmailBtn').click(function() {
                const username = $('#username').val().trim();
                
                if (!username) {
                    showError('Username is required');
                    return;
                }

                // Validate username format
                if (!/^[a-zA-Z0-9._-]+$/.test(username)) {
                    showError('Username can only contain letters, numbers, dots, underscores, and hyphens');
                    return;
                }

                $.ajax({
                    url: '@Url.Action("UpdateEmail", "Settings")',
                    type: 'POST',
                    data: {
                        username: username,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            showSuccess(response.message);
                            // Update the current email display
                            $('#currentEmail').val(username + '@@Model.Domain');
                        } else {
                            showError(response.message);
                        }
                    },
                    error: function() {
                        showError('Error updating email');
                    }
                });
            });

            // Update Password
            $('#updatePasswordBtn').click(function() {
                const currentPassword = $('#currentPassword').val();
                const newPassword = $('#newPassword').val();
                const confirmPassword = $('#confirmPassword').val();
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showError('All password fields are required');
                    return;
                }

                if (newPassword.length < 6) {
                    showError('New password must be at least 6 characters long');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showError('New password and confirmation do not match');
                    return;
                }

                $.ajax({
                    url: '@Url.Action("UpdatePassword", "Settings")',
                    type: 'POST',
                    data: {
                        currentPassword: currentPassword,
                        newPassword: newPassword,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            showSuccess(response.message);
                            // Clear password fields
                            $('#currentPassword, #newPassword, #confirmPassword').val('');
                        } else {
                            showError(response.message);
                        }
                    },
                    error: function() {
                        showError('Error updating password');
                    }
                });
            });

            // Helper functions
            function showSuccess(message) {
                $('#successMessage').text(message);
                $('#successToast').toast('show');
            }

            function showError(message) {
                $('#errorMessage').text(message);
                $('#errorToast').toast('show');
            }
        });
    </script>
}